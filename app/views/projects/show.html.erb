<% breadcrumb :project, [@tag, @project] %>

<div class= "projectShow">
  <div class= "heading1_box projectShow_heading1_box">
    <div class= "projectShow_heading1_left">
      <div class= "heading1"><%= @project.title %></div>
      <div class= "projectShow_projectTags">
        <% @project.tags.each do |tag| %>
          <div class= "projectShow_projectTag">
            <%= tag.tag_name %>
          </div>
        <% end %>
      </div>
    </div>
    <div class= "projectShow_heading1_right">
      <div class= "projectShow_overall_achievement">
        達成率：<span class= "projectShow_overall_achievement_rate"><%= @project.overall_achievement_rate %>%</span>
      </div>
    </div>
  </div>

  <div class= "projectShow_projectInfo">
    <div class= "projectShow_projectDescription_box">
      <div class= "heading2">概要</div>
      <div class= "projectShow_projectDescription">
        <%= simple_format(h(@project.description), {}, sanitize: false, wrapper_tag: "div") %>
      </div>
    </div>
    <div class= "projectShow_projectOwner_box">
      <div class= "heading2">作成者</div>
      <%= link_to(user_path(@project.owner, project: @project, tag: @tag), class: "link", style: "color: black;") do %>
        <div class= "projectShow_projectOwner">
          <div class= "projectShow_projectOwner_text"><%= @project.owner.nickname %></div>
          <div class= "projectShow_projectOwner_linkMessage">マイページはこちら➡</div>
        </div>
      <% end %>
    </div>
    <div class= "projectShow_projectManagement_box">
      <%= link_to(edit_project_path(@project), class: "link", style: "color: black;") do %>
        <div class= "projectShow_projectEdit">編集する</div>
      <% end %>
      <%= link_to(project_path(@project), data: {turbo_confirm: "付随するすべての習慣も削除されます。よろしいですか？", turbo_method: :delete}, class: "link", style: "color: black;") do %>
        <div class= "projectShow_projectDelete">削除する</div>
      <% end %>
    </div>
  </div>

  <% if params[:range] == "three_days" %>
    <h2>前後３日分の表示</h2>
    <%= link_to "１か月分表示", project_path(@project, range: "month") %>
    <table>
      <thead>
        <tr>
          <th>日付</th>
          <% @habits.each do |habit| %>
            <th><%= habit.name %></th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @three_day_range.each do |date| %>
          <tr>
            <td>
              <%= date.strftime("%m-%d") %>
            </td>
            <% @habits.each do |habit| %>
              <% check_in = habit.check_ins.find_or_create_by!(date: date) %>
              <td>
                <%= form_with model: check_in, url: project_habit_check_in_path(project_id: @project.id, habit_id: habit.id, id: check_in.id), method: :patch, class: "check_in", data: {project_id: @project.id, habit_id: habit.id, id: check_in.id} do |f| %>
                  <%= f.check_box :status, checked: check_in&.status %>
                  <%= f.hidden_field :habit_id, value: habit.id %>
                  <%= f.hidden_field :date, value: date %>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% elsif params[:range] == "month" %>
    <h2>１か月分の表示</h2>
    <%= link_to "前後３日表示", project_path(@project, range: "three_days") %>
    <table>
      <thead>
        <tr>
          <th>日付</th>
          <% @habits.each do |habit| %>
            <th><%= habit.name %></th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @month_range.each do |date| %>
          <tr>
            <td>
              <%= date.strftime("%m-%d") %>
            </td>
            <% @habits.each do |habit| %>
              <% check_in = habit.check_ins.find_or_create_by(date: date, habit_id: habit.id) %>
              <td>
                <%= form_with model: check_in, url: project_habit_check_in_path(project_id: @project.id, habit_id: habit.id, id: check_in.id), method: :patch, class: "check_in", data: {project_id: @project.id, habit_id: habit.id, id: check_in.id} do |f| %>
                  <%= f.check_box :status, checked: check_in&.status %>
                  <%= f.hidden_field :habit_id, value: habit.id %>
                  <%= f.hidden_field :date, value: date %>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

</div>






<h1><%= @project.title %></h1>

<%= @project.title %><br>
<%= @project.description %><br>
<%= @project.tags.first&.tag_name %><br>
<%= @project.display %><br>
達成率：<%= @project.overall_achievement_rate %>%
<%= link_to(user_path(@project.owner, project: @project, tag: @tag)) do %>
  <p>投稿者：<%= @project.owner.nickname %></p><br><br>
<% end %>

<%= link_to "プロジェクトを編集", edit_project_path(@project) %>
<%= link_to "プロジェクトを削除", project_path(@project), data: {turbo_confirm: "付随するすべての習慣も削除されます。よろしいですか？", turbo_method: :delete} %>



<h2>習慣内容</h2>
<%= link_to "習慣を作成する", new_project_habit_path(@project) %>
<table>
  <thead>
    <tr>
      <th>No</th>
      <th>内容</th>
      <th>頻度</th>
      <th>達成率</th>
    </tr>
  </thead>
  <tbody>
    <% @habits.each_with_index do |habit, index| %>
      <% start_date = habit.start_date || habit.created_at.to_date %>
      <% end_date = habit.end_date || Date.today %>
      <tr onclick="window.location='<%= project_habit_path(project_id: @project.id, id: habit.id, range: 'three_days', tag: @tag) %>'" style= "cursor: pointer;">
        <td>（<%= "#{index + 1}" %>）</td>
        <td><%= habit.content %></td>
        <td><%= habit.frequency %></td>
        <td><%= habit.achievement_rate(start_date, end_date) %>%</td>
      </tr>
    <% end %>
  </tbody>
</table>

